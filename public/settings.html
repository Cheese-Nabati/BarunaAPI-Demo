<!DOCTYPE html>
<html lang="id">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="UTF-8">
    <title>Pengaturan Sistem - BarunaAPI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        body { background-color: #f4f7f6; font-family: 'Segoe UI', sans-serif; }
        .navbar { box-shadow: 0 2px 4px rgba(0,0,0,.04); }
        .card { border: none; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,.05); }
        .nav-pills .nav-link { border-radius: 10px; color: #495057; font-weight: 600; padding: 12px 20px; }
        .nav-pills .nav-link.active { background-color: #4e73df; }
        .table-responsive { max-height: 500px; }
        .status-badge { font-size: 0.75rem; padding: 5px 10px; border-radius: 20px; }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-white sticky-top">
    <div class="container">
        <a class="navbar-brand fw-bold" href="/dashboard">BarunaAPI <span class="text-primary">Settings</span></a>
        <a href="/dashboard" class="btn btn-outline-secondary rounded-pill fw-bold">
            <i class="bi bi-arrow-left me-1"></i>Kembali
        </a>
    </div>
</nav>

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-12">
            <div class="card p-4">
                <h5 class="fw-bold mb-4"><i class="bi bi-cpu-fill me-2 text-primary"></i>Kontrol Perangkat ESP32</h5>
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>ID Alat</th>
                                <th>Mode Operasi</th>
                                <th>Pesan Running Text</th>
                                <th class="text-center">Power</th>
                                <th class="text-end">Terakhir Aktif</th>
                            </tr>
                        </thead>
                        <tbody id="device-list"></tbody>
                    </table>
                </div>
                <div class="alert alert-info mt-3 small">
                    <i class="bi bi-info-circle-fill me-2"></i>
                    <strong>READER:</strong> Absensi normal. <strong>WRITER:</strong> Mode pendaftaran. <strong>MAINTENANCE:</strong> Perbaikan.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Notification Modal -->
<div class="modal fade" id="notifyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div id="notifyHeader" class="modal-header text-white">
                <h5 id="notifyTitle" class="modal-title fw-bold">Notifikasi</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4 text-center">
                <i id="notifyIcon" class="bi display-4 mb-3 d-block"></i>
                <div id="notifyMessage" class="fs-5"></div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary w-100 fw-bold" data-bs-dismiss="modal">Tutup</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const notifyModal = new bootstrap.Modal(document.getElementById('notifyModal'));
    let activeInputId = null;

    function showNotification(type, title, message) {
        const header = document.getElementById('notifyHeader');
        const icon = document.getElementById('notifyIcon');
        const titleEl = document.getElementById('notifyTitle');
        const messageEl = document.getElementById('notifyMessage');

        header.className = `modal-header text-white bg-${type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'danger'}`;
        icon.className = `bi display-4 mb-3 d-block bi-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'x-circle'}`;
        
        titleEl.innerText = title;
        messageEl.innerHTML = message;
        notifyModal.show();
    }

    // --- INITIAL LOAD ---
    window.onload = () => {
        loadDevices();
        setInterval(() => {
            if (!activeInputId) loadDevices();
        }, 5000); 
    };

    // --- DEVICE LOGIC ---
    async function loadDevices() {
        try {
            const res = await fetch('/api/admin/devices');
            const data = await res.json();
            const list = document.getElementById('device-list');

            list.innerHTML = data.map(dev => {
                // Since SQL returns local time now, we compare it with local Date
                const lastSeenDate = new Date(dev.last_seen.replace(' ', 'T'));
                const isOnline = (new Date() - lastSeenDate) < 40000; // 40s buffer
                
                return `
                <tr>
                    <td><strong>${dev.device_id}</strong></td>
                    <td>
                        <select onchange="updateDevice('${dev.device_id}', this.value, null, null)" class="form-select form-select-sm">
                            <option value="READER" ${dev.mode === 'READER' ? 'selected' : ''}>READER</option>
                            <option value="WRITER" ${dev.mode === 'WRITER' ? 'selected' : ''}>WRITER</option>
                            <option value="MAINTENANCE" ${dev.mode === 'MAINTENANCE' ? 'selected' : ''}>MAINTENANCE</option>
                        </select>
                    </td>
                    <td>
                        <div class="input-group input-group-sm">
                            <input type="text" id="text-${dev.device_id}" class="form-control" 
                                value="${dev.display_text || 'Silahkan Tap Kartu RFID!'}" 
                                onfocus="activeInputId='${dev.device_id}'" 
                                onblur="setTimeout(()=>activeInputId=null, 500)">
                            <button class="btn btn-primary" onclick="saveDisplayText('${dev.device_id}')">
                                <i class="bi bi-save"></i>
                            </button>
                        </div>
                    </td>
                    <td class="text-center">
                        <div class="form-check form-switch d-inline-block">
                            <input class="form-check-input" type="checkbox" onchange="updateDevice('${dev.device_id}', null, null, this.checked ? 1 : 0)" ${dev.power_status ? 'checked' : ''}>
                        </div>
                    </td>
                    <td class="text-end">
                        ${isOnline ? 
                            '<span class="badge bg-success shadow-sm">ONLINE</span>' : 
                            `<span class="text-muted small">${dev.last_seen}</span>`
                        }
                    </td>
                </tr>
                `;
            }).join('');
        } catch (e) {}
    }

    async function saveDisplayText(id) {
        const text = document.getElementById(`text-${id}`).value;
        await updateDevice(id, null, text, null);
    }

    async function updateDevice(id, mode, text, power) {
        const body = { device_id: id };
        if (mode) body.mode = mode;
        if (text !== null) body.display_text = text;
        if (power !== null) body.power_status = power;

        try {
            const res = await fetch('/api/admin/devices/update', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(body)
            });
            if (res.ok) {
                if (text !== null) showNotification('success', 'Berhasil', 'Pesan Running Text telah diperbarui!');
            } else {
                showNotification('error', 'Gagal', 'Terjadi kesalahan saat memperbarui alat.');
            }
        } catch (e) {
            showNotification('error', 'Kesalahan', 'Gagal terhubung ke server.');
        }
        loadDevices();
    }
</script>
</body>
</html>