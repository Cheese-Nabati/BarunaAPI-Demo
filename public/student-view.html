<!DOCTYPE html>
<html lang="id">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="UTF-8">
    <title>Database Siswa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', sans-serif;
        }
        .navbar {
            box-shadow: 0 2px 4px rgba(0,0,0,.04);
        }
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,.05);
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-white sticky-top">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold text-dark" href="#">Database Siswa</a>
        <a href="/dashboard" class="btn btn-outline-primary rounded-pill fw-bold px-3">
            <i class="bi bi-arrow-left me-1"></i>Kembali
        </a>
    </div>
</nav>

<main class="container py-4">
    <div class="card">
        <div class="card-header bg-white border-0 py-3">
            <div class="row justify-content-between align-items-center g-2">
                <div class="col-md-5">
                    <h5 class="card-title fw-bold mb-0">Manajemen Data Siswa</h5>
                </div>
                <div class="col-md-4">
                     <div class="input-group">
                        <label class="input-group-text border-end-0 bg-white" for="studentSearch"><i class="bi bi-search"></i></label>
                        <input type="text" id="studentSearch" class="form-control border-start-0" placeholder="Cari Nama/UID/Kelas..." oninput="renderTable()">
                        
                        <label class="input-group-text border-end-0 bg-white ms-2" for="classFilter"><i class="bi bi-funnel"></i></label>
                        <select class="form-select" id="classFilter" onchange="renderTable()">
                            <option value="ALL" selected>Semua Kelas</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-3 text-md-end">
                    <button class="btn btn-primary rounded-pill fw-bold px-3" onclick="showAddModal()">
                        <i class="bi bi-plus-circle-fill me-1"></i>Tambah Siswa
                    </button>
                    <button class="btn btn-danger rounded-pill" onclick="showBulkDeleteModal()" title="Hapus Massal">
                        <i class="bi bi-trash3-fill"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>UID Kartu</th>
                            <th>Nama Lengkap</th>
                            <th>Kelas</th>
                            <th class="text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="student-table">
                        <tr><td colspan="4" class="text-center p-5"><div class="spinner-border text-primary"></div></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</main>
<div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold">Pendaftaran Siswa Baru</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                 <div class="mb-3">
                    <label class="form-label small fw-bold d-flex justify-content-between">
                        UID KARTU RFID
                        <span class="badge bg-info text-dark" style="font-size: 0.65rem;">
                            <i class="bi bi-cpu-fill me-1"></i>AUTO-SCAN (WRITER MODE)
                        </span>
                    </label>
                    <input type="text" id="inp_uid" class="form-control bg-light" placeholder="Scan kartu pada ESP32..." readonly>
                    <div class="form-text">UID akan terisi otomatis saat kartu ditempelkan pada alat.</div>
                </div>
                <div class="mb-3">
                    <label class="form-label small fw-bold">NAMA LENGKAP</label>
                    <input type="text" id="inp_nama" class="form-control">
                </div>
                <div class="row">
                    <div class="col-6 mb-3">
                        <label class="form-label small fw-bold">TINGKAT KELAS</label>
                        <select id="inp_tingkat" class="form-select">
                            <option value="" selected disabled>Pilih...</option>
                            <option value="10">10</option>
                            <option value="11">11</option>
                            <option value="12">12</option>
                        </select>
                    </div>
                    <div class="col-6 mb-3">
                        <label class="form-label small fw-bold">JURUSAN</label>
                        <select id="inp_jurusan" class="form-select">
                            <option value="" selected disabled>Pilih...</option>
                            <option value="TJKT">TJKT</option>
                            <option value="DKV 1">DKV 1</option>
                            <option value="DKV 2">DKV 2</option>
                        </select>
                    </div>
                </div>
            </div>
             <div class="modal-footer border-0">
                <button onclick="saveNewStudent()" class="btn btn-primary w-100 fw-bold py-2">
                    Simpan ke Database
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Delete Modal -->
<div class="modal fade" id="bulkDeleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title fw-bold">Hapus Siswa per Kelas</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <p>Pilih kelas yang ingin Anda hapus seluruh datanya. Tindakan ini tidak dapat dibatalkan.</p>
                <select id="del_class_name" class="form-select mb-3"></select>
            </div>
            <div class="modal-footer border-0">
                 <button onclick="bulkDelete()" class="btn btn-danger w-100 fw-bold">Hapus Semua Siswa di Kelas Ini</button>
            </div>
        </div>
    </div>
</div>

<!-- Notification Modal -->
<div class="modal fade" id="notifyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div id="notifyHeader" class="modal-header text-white">
                <h5 id="notifyTitle" class="modal-title fw-bold">Notifikasi</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4 text-center">
                <i id="notifyIcon" class="bi display-4 mb-3 d-block"></i>
                <div id="notifyMessage" class="fs-5"></div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary w-100 fw-bold" data-bs-dismiss="modal">Tutup</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirm Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title fw-bold">Konfirmasi Tindakan</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4 text-center">
                <i class="bi bi-exclamation-triangle display-4 mb-3 d-block text-warning"></i>
                <div id="confirmMessage" class="fs-5"></div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light flex-grow-1" data-bs-dismiss="modal">Batal</button>
                <button type="button" id="confirmOkBtn" class="btn btn-warning flex-grow-1 fw-bold">Ya, Lanjutkan</button>
            </div>
        </div>
    </div>
</div>

<footer class="py-4 mt-4 text-center">
    <small class="text-muted">Sistem Monitoring Absensi Â© 2025 SMKS 1 Barunawati</small>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let allStudents = [];
    const studentTable = document.getElementById('student-table');
    const classFilter = document.getElementById('classFilter');
    const bulkDelSelect = document.getElementById('del_class_name');
    const addModalEl = document.getElementById('addModal');
    const addModal = new bootstrap.Modal(addModalEl);
    const notifyModal = new bootstrap.Modal(document.getElementById('notifyModal'));
    const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));

    // --- Global Console Override ---
    const originalConsoleError = console.error;
    const originalConsoleWarn = console.warn;
    const originalConsoleLog = console.log;
    
    function formatConsoleArgs(args) {
        return args.map(arg => {
            if (arg instanceof Error) return arg.message;
            if (typeof arg === 'object') {
                try { return JSON.stringify(arg); } catch(e) { return String(arg); }
            }
            return String(arg);
        }).join(' ');
    }

    console.error = function(...args) {
        originalConsoleError.apply(console, args);
        if (typeof args[0] === 'string' && args[0].includes("Scan check failed")) return;
        showNotification('error', 'Kesalahan Konsol', formatConsoleArgs(args));
    };

    console.warn = function(...args) {
        originalConsoleWarn.apply(console, args);
        showNotification('warning', 'Peringatan Konsol', formatConsoleArgs(args));
    };

    console.log = function(...args) {
        originalConsoleLog.apply(console, args);
        // Optional: filter out common logs if too noisy, but following "all notification"
        if (typeof args[0] === 'string' && (args[0].includes("render") || args[0].includes("update"))) return;
        showNotification('info', 'Info Konsol', formatConsoleArgs(args));
    };

    function showNotification(type, title, message) {
        const header = document.getElementById('notifyHeader');
        const icon = document.getElementById('notifyIcon');
        const titleEl = document.getElementById('notifyTitle');
        const messageEl = document.getElementById('notifyMessage');

        const bgClass = type === 'success' ? 'text-bg-success' : 
                        type === 'warning' ? 'text-bg-warning' : 
                        type === 'info' ? 'text-bg-info' : 'text-bg-danger';
        
        header.className = `modal-header ${bgClass}`;
        
        const iconClass = type === 'success' ? 'bi-check-circle' : 
                          type === 'warning' ? 'bi-exclamation-triangle' : 
                          type === 'info' ? 'bi-info-circle' : 'bi-x-circle';
        
        icon.className = `bi display-4 mb-3 d-block ${iconClass}`;
        
        const iconColor = type === 'success' ? '#198754' : 
                          type === 'warning' ? '#ffc107' : 
                          type === 'info' ? '#0dcaf0' : '#dc3545';
        icon.style.color = iconColor;
        
        titleEl.innerText = title;
        messageEl.innerHTML = message;
        notifyModal.show();
    }

    function showConfirm(message, callback) {
        document.getElementById('confirmMessage').innerHTML = message;
        const confirmOkBtn = document.getElementById('confirmOkBtn');
        
        // Remove old listeners by replacing the element
        const newOkBtn = confirmOkBtn.cloneNode(true);
        confirmOkBtn.parentNode.replaceChild(newOkBtn, confirmOkBtn);
        
        newOkBtn.addEventListener('click', () => {
            confirmModal.hide();
            callback();
        });
        
        confirmModal.show();
    }

    async function loadStudents() {
        try {
            const res = await fetch('/api/students');
            allStudents = await res.json();
            updateClassOptions();
            renderTable();
        } catch (err) {
            studentTable.innerHTML = `<tr><td colspan="4" class="text-center p-5 text-danger">Gagal memuat data siswa.</td></tr>`;
        }
    }

    function renderTable() {
        const filterValue = classFilter.value;
        const searchTerm = document.getElementById('studentSearch').value.toLowerCase().trim();

        const filtered = allStudents.filter(s => {
            const matchesClass = filterValue === "ALL" || s.class === filterValue;
            const matchesSearch = 
                s.name.toLowerCase().includes(searchTerm) || 
                s.rfid_uid.toLowerCase().includes(searchTerm) || 
                s.class.toLowerCase().includes(searchTerm);
            
            return matchesClass && matchesSearch;
        });

        if (filtered.length === 0) {
            studentTable.innerHTML = `<tr><td colspan="4" class="text-center p-5 text-muted">${searchTerm ? 'Tidak ditemukan hasil pencarian.' : 'Tidak ada data siswa.'}</td></tr>`;
            return;
        }

        studentTable.innerHTML = filtered.map(s => `
            <tr>
                <td><code>${s.rfid_uid}</code></td>
                <td><span class="fw-bold">${s.name}</span></td>
                <td><span class="badge bg-secondary">${s.class}</span></td>
                <td class="text-center">
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteSingle('${s.rfid_uid}')"><i class="bi bi-trash"></i></button>
                </td>
            </tr>
        `).join('');
    }

    function updateClassOptions() {
        const classes = [...new Set(allStudents.map(s => s.class))].sort();
        const currentFilter = classFilter.value;
        
        let options = `<option value="ALL">Semua Kelas</option>`;
        let deleteOptions = `<option value="" selected disabled>-- Pilih Kelas --</option>`;

        classes.forEach(c => {
            options += `<option value="${c}">${c}</option>`;
            deleteOptions += `<option value="${c}">${c}</option>`;
        });

        classFilter.innerHTML = options;
        bulkDelSelect.innerHTML = deleteOptions;
        classFilter.value = classes.includes(currentFilter) ? currentFilter : "ALL";
    }

    function showAddModal() {
        addModalEl.querySelector('form')?.reset();
        document.getElementById('inp_uid').value = "";
        document.getElementById('inp_nama').value = "";
        document.getElementById('inp_tingkat').value = "";
        document.getElementById('inp_jurusan').value = "";
        addModal.show();
    }

    async function saveNewStudent() {
        const rfid_uid = document.getElementById('inp_uid').value.trim();
        const name = document.getElementById('inp_nama').value.trim();
        const tingkat = document.getElementById('inp_tingkat').value;
        const jurusan = document.getElementById('inp_jurusan').value;

        if (!rfid_uid || !name || !tingkat || !jurusan) {
            return showNotification('error', 'Data Tidak Lengkap', 'Harap lengkapi semua data siswa!');
        }

        const className = `${tingkat} ${jurusan}`;
        const btn = addModalEl.querySelector('.btn-primary');
        btn.disabled = true;

        try {
            const res = await fetch('/api/students', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ rfid_uid, name, class: className })
            });
            const result = await res.json();
            if (!res.ok) throw new Error(result.message || "Error tidak diketahui");
            
            addModal.hide();
            showNotification('success', 'Berhasil!', 'Siswa Berhasil Didaftarkan!');
            loadStudents();
        } catch (err) {
            showNotification('error', 'Gagal', err.message);
        } finally {
            btn.disabled = false;
        }
    }

    async function deleteSingle(uid) {
        showConfirm("Apakah Anda yakin ingin menghapus siswa ini?", async () => {
            try {
                 await fetch(`/api/students/${uid}`, { method: 'DELETE' });
                 loadStudents();
            } catch(err) {
                showNotification('error', 'Gagal', 'Gagal menghapus siswa.');
            }
        });
    }

    function showBulkDeleteModal() {
        if (bulkDelSelect.options.length <= 1) {
            return showNotification('warning', 'Peringatan', 'Tidak ada data kelas untuk dihapus.');
        }
        new bootstrap.Modal(document.getElementById('bulkDeleteModal')).show();
    }

    async function bulkDelete() {
        const className = bulkDelSelect.value;
        if(!className) return showNotification('error', 'Gagal', 'Harap pilih kelas yang valid!');
        
        showConfirm(`PERINGATAN!\nYakin ingin hapus SEMUA siswa dari kelas '${className}'? Tindakan ini tidak dapat dibatalkan.`, async () => {
            const modal = bootstrap.Modal.getInstance(document.getElementById('bulkDeleteModal'));
            try {
                const res = await fetch('/api/students/bulk-delete', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ class_name: className })
                });
                if (!res.ok) throw new Error("Gagal menghapus.");
                showNotification('success', 'Berhasil!', `Berhasil menghapus semua siswa dari kelas ${className}`);
                modal.hide();
                loadStudents();
            } catch(err) {
                 showNotification('error', 'Gagal', err.message);
            }
        });
    }

    window.onload = () => {
        loadStudents();
        setInterval(checkDeviceScans, 3000); // Poll for card scans every 3 seconds
    };

    let lastSeenScanUid = null;

    async function checkDeviceScans() {
        try {
            const res = await fetch('/api/admin/devices');
            const devices = await res.json();
            
            // Look for any device in WRITER mode that scanned a card recently
            const writerDevice = devices.find(d => d.mode === 'WRITER' && d.last_scanned_uid);
            
            if (writerDevice && writerDevice.last_scanned_uid !== lastSeenScanUid) {
                lastSeenScanUid = writerDevice.last_scanned_uid;
                
                // Fetch student info for this UID
                const s = allStudents.find(student => student.rfid_uid === lastSeenScanUid);
                
                if (s) {
                    // Registered: Show Info Modal
                    showNotification('warning', 'Kartu Sudah Terdaftar', `
                        <div class="text-start">
                            <p><strong>Nama:</strong> ${s.name}</p>
                            <p><strong>Kelas:</strong> ${s.class}</p>
                            <p><strong>UID:</strong> ${s.rfid_uid}</p>
                        </div>
                    `);
                } else {
                    // New: Open Add Modal and fill UID
                    showAddModal();
                    document.getElementById('inp_uid').value = lastSeenScanUid;
                    // Optional: auto-focus name field
                    setTimeout(() => document.getElementById('inp_nama').focus(), 500);
                }
            }
        } catch (e) { console.error("Scan check failed", e); }
    }
</script>
</body>
</html>
