<!DOCTYPE html>
<html lang="id">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta charset="UTF-8">
    <title>Dashboard Absensi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', sans-serif;
        }
        .navbar {
            box-shadow: 0 2px 4px rgba(0,0,0,.04);
        }
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,.05);
        }
        .status-dot {
            width: 10px;
            height: 10px;
        }
        .action-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem;
            border-radius: 12px;
            transition: background-color 0.2s ease-in-out;
        }
        .action-btn i {
            font-size: 1.75rem;
        }
        .table-responsive {
            max-height: 60vh;
        }
    </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-white sticky-top">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold text-dark" href="#">Dashboard Absensi</a>
        <div class="d-flex align-items-center">
            <div class="d-flex align-items-center bg-light p-2 rounded-pill me-3">
                <span class="status-dot bg-success rounded-circle me-2"></span>
                <small class="fw-bold text-success">ONLINE</small>
            </div>
            <button onclick="doLogout()" class="btn btn-outline-danger rounded-pill fw-bold px-3">
                <i class="bi bi-box-arrow-right me-1"></i>Logout
            </button>
        </div>
    </div>
</nav>

<main class="container py-4">
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title fw-bold mb-3">Panel Manajemen</h5>
            <div class="row g-2 text-center">
                <div class="col">
                    <a href="/student-view" class="btn btn-light action-btn w-100 h-100">
                        <i class="bi bi-people-fill text-primary"></i>
                        <span class="small fw-bold">Database Siswa</span>
                    </a>
                </div>
                <div class="col">
                    <a href="/settings" class="btn btn-light action-btn w-100 h-100">
                        <i class="bi bi-gear-fill text-dark"></i>
                        <span class="small fw-bold">Pengaturan Sistem</span>
                    </a>
                </div>
                <div class="col">
                    <a href="/recap-view" class="btn btn-light action-btn w-100 h-100">
                        <i class="bi bi-file-earmark-spreadsheet-fill text-info"></i>
                        <span class="small fw-bold">Laporan Akumulasi</span>
                    </a>
                </div>
                <div class="col">
                    <button onclick="doRekap()" class="btn btn-light action-btn w-100 h-100">
                        <i class="bi bi-calendar-check-fill text-warning"></i>
                        <span class="small fw-bold">Akumulasi Bulanan</span>
                    </button>
                </div>
                 <div class="col">
                    <button onclick="resetLogs()" class="btn btn-light action-btn w-100 h-100">
                        <i class="bi bi-trash3-fill text-danger"></i>
                        <span class="small fw-bold">Reset Log</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-white border-0 py-3">
            <h5 class="card-title fw-bold mb-0">Aktivitas Absensi Terkini</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Waktu</th>
                            <th>Tanggal</th>
                            <th>Nama</th>
                            <th>Kelas</th>
                            <th>ID Alat</th>
                        </tr>
                    </thead>
                    <tbody id="log-table">
                        <tr><td colspan="5" class="text-center p-5"><div class="spinner-border text-primary"></div></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</main>

<!-- Modals -->
<div class="modal fade" id="LogoutModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title fw-bold">Konfirmasi Logout</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <p>Apakah Anda yakin ingin keluar dari sesi ini?</p>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Batal</button>
                <button onclick="executeLogout()" class="btn btn-danger px-4 fw-bold">Logout</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="rekapModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning border-0">
                <h5 class="modal-title fw-bold">Konfirmasi Akumulasi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <p class="mb-2">Proses log absensi menjadi rekap permanen untuk bulan ini?</p>
                <h5 id="rekapBulanTeks" class="fw-bold text-primary my-3"></h5>
                <p class="text-muted small mt-2">Tindakan ini akan mengelompokkan absensi berdasarkan UID siswa.</p>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Batal</button>
                <button onclick="executeRekap()" class="btn btn-warning px-4 fw-bold">Proses Sekarang</button>
            </div>
        </div>
    </div>
</div>

<!-- Reset Logs Warning Modal -->
<div class="modal fade" id="resetLogsModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white border-0">
                <h5 class="modal-title fw-bold">Peringatan Penghapusan</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <i class="bi bi-exclamation-triangle-fill text-danger display-1 mb-3"></i>
                <p class="fw-bold">Apakah Anda yakin ingin menghapus SELURUH log absensi?</p>
                <p class="text-muted small">Pastikan Anda sudah menjalankan 'Akumulasi' agar data tidak hilang. Tindakan ini permanen.</p>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Batal</button>
                <button onclick="executeResetLogs()" class="btn btn-danger px-4 fw-bold">Ya, Hapus Semua</button>
            </div>
        </div>
    </div>
</div>

<!-- Notification Modal -->
<div class="modal fade" id="notifyModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div id="notifyHeader" class="modal-header text-white">
                <h5 id="notifyTitle" class="modal-title fw-bold">Notifikasi</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4 text-center">
                <i id="notifyIcon" class="bi display-4 mb-3 d-block"></i>
                <div id="notifyMessage" class="fs-5"></div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary w-100 fw-bold" data-bs-dismiss="modal">Tutup</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const logTable = document.getElementById('log-table');
    const notifyModal = new bootstrap.Modal(document.getElementById('notifyModal'));

    function showNotification(type, title, message) {
        const header = document.getElementById('notifyHeader');
        const icon = document.getElementById('notifyIcon');
        const titleEl = document.getElementById('notifyTitle');
        const messageEl = document.getElementById('notifyMessage');

        header.className = `modal-header text-white bg-${type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'danger'}`;
        icon.className = `bi display-4 mb-3 d-block bi-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'x-circle'}`;
        icon.style.color = type === 'success' ? '#198754' : type === 'warning' ? '#ffc107' : '#dc3545';
        
        titleEl.innerText = title;
        messageEl.innerHTML = message;
        notifyModal.show();
    }

    async function loadLogs() {
        try {
            const res = await fetch('/api/logs');
            const data = await res.json();
            if (data.length === 0) {
                 logTable.innerHTML = `<tr><td colspan="5" class="text-center p-5 text-muted">Belum ada aktivitas.</td></tr>`;
                 return;
            }
            logTable.innerHTML = data.map(log => `
                <tr>
                    <td><span class="badge bg-light text-dark border">${log.timestamp.split(' ')[1]}</span></td>
                    <td><span class="small text-muted">${log.date || log.timestamp.split(' ')[0]}</span></td>
                    <td><strong>${log.name || 'Siswa Belum Terdaftar'}</strong></td>
                    <td>${log.class || '-'}</td>
                    <td><span class="badge bg-secondary">${log.device_id}</span></td>
                </tr>
            `).join('');
        } catch (e) {
            logTable.innerHTML = `<tr><td colspan="5" class="text-center p-5 text-danger">Gagal memuat data.</td></tr>`;
        }
    }

    function doRekap() {
        const now = new Date();
        const month = now.toLocaleString('default', { month: 'long' });
        const year = now.getFullYear();
        document.getElementById('rekapBulanTeks').innerText = `${month} ${year}`;
        new bootstrap.Modal(document.getElementById('rekapModal')).show();
    }

    function doLogout() {
        new bootstrap.Modal(document.getElementById('LogoutModal')).show();
    }

    function executeLogout() {
        const btn = document.querySelector('#LogoutModal .btn-danger');
        btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Logging out...';
        btn.disabled = true;
        setTimeout(() => window.location.href = '/logout', 1500);
    }

    async function executeRekap() {
        const modalInstance = bootstrap.Modal.getInstance(document.getElementById('rekapModal'));
        const btn = document.querySelector('#rekapModal .btn-warning');
        btn.disabled = true;

        try {
            const res = await fetch('/api/admin/recap-bulanan');
            const data = await res.json();
            modalInstance.hide();
            
            if (res.ok) {
                showNotification('success', 'Berhasil!', `Data bulan ${data.month} telah diakumulasi.`);
            } else {
                showNotification('error', 'Gagal!', data.message || "Error tidak diketahui");
            }
        } catch (err) {
            showNotification('error', 'Kesalahan!', "Gagal terhubung ke server untuk melakukan rekap.");
        } finally {
            btn.disabled = false;
        }
    }

    function resetLogs() {
        new bootstrap.Modal(document.getElementById('resetLogsModal')).show();
    }

    async function executeResetLogs() {
        const modalInstance = bootstrap.Modal.getInstance(document.getElementById('resetLogsModal'));
        const btn = document.querySelector('#resetLogsModal .btn-danger');
        btn.disabled = true;

        try {
            const res = await fetch('/api/logs/reset', { method: 'DELETE' });
            const result = await res.json();
            modalInstance.hide();

            if (res.ok) {
                showNotification('success', 'Berhasil!', result.message);
                loadLogs();
            } else {
                showNotification('error', 'Gagal!', result.message);
            }
        } catch (err) {
            showNotification('error', 'Kesalahan!', "Terjadi kesalahan koneksi saat mereset log.");
        } finally {
            btn.disabled = false;
        }
    }

    loadLogs();
    setInterval(loadLogs, 5000);
</script>
</body>
</html>
